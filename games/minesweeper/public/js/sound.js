/**
 * Sound: retro bleeps generated by WebAudio (no copyrighted assets).
 * Global namespace: window.MSSound
 */
(function () {
  "use strict";

  let ctx = null;

  function ensureCtx() {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }

  function beep({ type = "square", freq = 440, duration = 0.08, gain = 0.06, sweep = null }) {
    const ac = ensureCtx();
    const now = ac.currentTime;

    const osc = ac.createOscillator();
    const g = ac.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(freq, now);
    if (sweep) {
      osc.frequency.linearRampToValueAtTime(sweep.to, now + duration);
    }

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(g);
    g.connect(ac.destination);

    osc.start(now);
    osc.stop(now + duration + 0.02);
  }

  const SFX = {
    open() { beep({ type: "square", freq: 620, duration: 0.05, gain: 0.05, sweep: { to: 720 } }); },
    flag() { beep({ type: "triangle", freq: 380, duration: 0.06, gain: 0.05, sweep: { to: 300 } }); },
    unflag() { beep({ type: "triangle", freq: 300, duration: 0.06, gain: 0.04, sweep: { to: 380 } }); },
    boom() { beep({ type: "sawtooth", freq: 120, duration: 0.18, gain: 0.07, sweep: { to: 60 } }); },
    win() {
      beep({ type: "square", freq: 523, duration: 0.08, gain: 0.05 });
      setTimeout(() => beep({ type: "square", freq: 659, duration: 0.08, gain: 0.05 }), 90);
      setTimeout(() => beep({ type: "square", freq: 784, duration: 0.10, gain: 0.05 }), 180);
    },
    click() { beep({ type: "square", freq: 260, duration: 0.03, gain: 0.03 }); },
  };

  async function unlockAudio() {
    // iOS needs user gesture to resume
    try {
      const ac = ensureCtx();
      if (ac.state === "suspended") await ac.resume();
    } catch {
      // ignore
    }
  }

  window.MSSound = { SFX, unlockAudio };
})();
