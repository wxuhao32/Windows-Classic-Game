<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#c0c0c0" />
  <title>扫雷 Minesweeper（复古 Win98 风）</title>
  <!-- ⚠️ 重要：使用相对路径，确保 file:// 直接打开也能加载到资源 -->
  <link rel="stylesheet" href="./css/styles.css?v=1.0.12" />
</head>
<body>
  <a class="skip-link" href="#board">跳到棋盘</a>

  <main class="app" aria-labelledby="appTitle">
    <header class="window" role="region" aria-label="扫雷游戏窗口">
      <div class="titlebar">
        <div class="titlebar__left">
          <span class="titlebar__icon" aria-hidden="true"></span>
          <h1 id="appTitle" class="titlebar__title">Minesweeper</h1>
        </div>
        <div class="titlebar__right" aria-hidden="true">
          <span class="titlebar__btn"></span>
          <span class="titlebar__btn"></span>
          <span class="titlebar__btn titlebar__btn--close"></span>
        </div>
      </div>

      <div class="menubar" role="toolbar" aria-label="游戏设置">
        <div class="menubar__group">
          <label class="label" for="difficulty">难度</label>
          <select id="difficulty" class="select" aria-label="选择难度">
            <option value="beginner">初级 9×9 / 10雷</option>
            <option value="intermediate">中级 16×16 / 40雷</option>
            <option value="expert">高级 30×16 / 99雷</option>
            <option value="custom">自定义…</option>
          </select>

          <button id="themeToggle" class="btn" type="button" aria-label="切换主题（Classic / Dark）">
            主题：<span id="themeName">Classic</span>
          </button>

          <button id="soundToggle" class="btn" type="button" aria-label="开关音效">
            音效：<span id="soundName">开</span>
          </button>

          <button id="musicToggle" class="btn" type="button" aria-label="开关背景音乐">
            音乐：<span id="musicName">关</span>
          </button>
        </div>

        <div class="menubar__group menubar__group--right">
          <button id="fullscreenBtnTop" class="btn" type="button" data-fullscreen-btn aria-label="进入或退出全屏（优先竖屏）">全屏</button>
          <button id="rulesBtn" class="btn" type="button" aria-label="打开详细规则">规则</button>
          <button id="helpBtn" class="btn" type="button" aria-label="打开玩法帮助">帮助</button>
        </div>
      </div>

      <section class="panel" aria-label="计分板">
        <div class="counter" aria-label="剩余雷数">
          <div class="seg" id="minesCounter" aria-hidden="true"></div>
          <div class="sr-only" id="minesCounterText" aria-live="polite"></div>
        </div>

        <button id="resetBtn" class="smiley" type="button" aria-label="重新开始">
          <span class="smiley__face" aria-hidden="true"></span>
        </button>

        <div class="counter" aria-label="计时器">
          <div class="seg" id="timeCounter" aria-hidden="true"></div>
          <div class="sr-only" id="timeCounterText" aria-live="polite"></div>
        </div>
      </section>

      <section class="mobile-actions" aria-label="手机操作栏">
        <div class="segmented" role="tablist" aria-label="触屏操作模式">
          <button class="segmented__btn" id="modeReveal" role="tab" aria-selected="true">翻开</button>
          <button class="segmented__btn" id="modeFlag" role="tab" aria-selected="false">插旗</button>
          <button class="segmented__btn" id="modeChord" role="tab" aria-selected="false">快速翻开</button>
        </div>
        <p class="hint" id="touchHint">提示：也支持<strong>长按插旗</strong>（避免误触）。</p>
        <div class="mobile-tools" aria-label="手机辅助工具">
          <label class="label" for="zoomRange">格子大小</label>
          <input id="zoomRange" class="range" type="range" min="16" max="44" step="1" value="28" aria-label="调整格子大小" />
          <button id="fitBtn" class="btn" type="button" aria-label="一键适配屏幕">适配</button>
          <button id="fullscreenBtn" class="btn" data-fullscreen-btn type="button" aria-label="进入或退出全屏（优先竖屏）">全屏</button>
          <button id="collapseBtn" class="btn" type="button" aria-label="折叠或展开上方面板">折叠面板</button>
        </div>
      </section>

      <section class="board-wrap" aria-label="扫雷棋盘区域">
        <div id="boardTip" class="board-tip" role="note" aria-live="polite">
          <strong>👇 点击棋盘开始</strong>（长按插旗；上方可切换“插旗/快速翻开”）
        </div>
        <div class="board-header">
          <div class="status" id="statusText" aria-live="polite"></div>
          <div class="kbd-hint" aria-hidden="true">键盘：方向键移动 / 空格翻开 / F 插旗 / Enter 快速翻开</div>
        </div>

        <div
          id="board"
          class="board"
          role="grid"
          aria-label="扫雷棋盘"
          aria-describedby="touchHint"
          tabindex="0"
        ></div>
      </section>
    </header>

    <footer class="footer">
      <p>
        复古扫雷 · 原生 JS · 可部署到 Render。
        <a href="#" id="openAbout">关于与快捷键</a>
      </p>
    </footer>
  </main>

  <!-- 自定义难度对话框 -->
  <dialog id="customDialog" class="dialog" aria-label="自定义难度设置">
    <form method="dialog" class="dialog__content">
      <h2 class="dialog__title">自定义难度</h2>
      <p class="dialog__desc">请设置宽度、高度与雷数。会进行合理性校验（雷数必须小于格子数，并保留首次点击安全区域）。</p>

      <div class="form-grid">
        <label class="label" for="customW">宽（列）</label>
        <input id="customW" class="input" type="number" min="5" max="40" value="16" />

        <label class="label" for="customH">高（行）</label>
        <input id="customH" class="input" type="number" min="5" max="30" value="16" />

        <label class="label" for="customM">雷数</label>
        <input id="customM" class="input" type="number" min="1" max="300" value="40" />
      </div>

      <div class="dialog__actions">
        <button class="btn" value="cancel" type="submit">取消</button>
        <button class="btn btn--primary" id="customApply" value="apply" type="submit">应用</button>
      </div>

      <p class="error" id="customError" role="alert" aria-live="assertive"></p>
    </form>
  </dialog>


<!-- 详细规则对话框（内置到游戏中） -->
<dialog id="rulesDialog" class="dialog" aria-label="扫雷详细规则">
  <form method="dialog" class="dialog__content dialog__content--wide">
    <h2 class="dialog__title">扫雷详细规则</h2>

    <div class="rules">
      <section>
        <h3>目标</h3>
        <p>在不踩到任何地雷（💣）的前提下，<strong>翻开所有非雷格子</strong> 即获胜。</p>
      </section>

      <section>
        <h3>数字含义（最重要）</h3>
        <p>翻开后显示的数字 <strong>1~8</strong> 表示：它周围 8 个相邻格（包含斜对角）里有多少个地雷。</p>
        <ul>
          <li>例如：数字 <strong>3</strong> 代表周围 8 格里有 3 个雷、5 个安全格。</li>
          <li>数字为 <strong>0</strong> 的格子不会显示数字，并会自动连锁展开周围空白区域。</li>
        </ul>
      </section>

      <section>
        <h3>插旗（🚩）</h3>
        <ul>
          <li>旗帜用于标记“你认为这里是雷”的格子。</li>
          <li><strong>剩余雷数</strong> = 总雷数 - 你插的旗数量（只反映“还能插多少旗”，不代表一定正确）。</li>
        </ul>
      </section>

      <section>
        <h3>操作方式</h3>
        <div class="two-col">
          <div>
            <h4>电脑端</h4>
            <ul>
              <li><strong>左键</strong>：翻开</li>
              <li><strong>右键</strong>：插旗/取消旗</li>
              <li><strong>双击数字</strong>：快速翻开周围（见下）</li>
              <li><strong>键盘</strong>：方向键移动；空格翻开；F 插旗；Enter 快速翻开</li>
            </ul>
          </div>
          <div>
            <h4>手机端</h4>
            <ul>
              <li>模式按钮：<strong>翻开 / 插旗 / 快速翻开</strong></li>
              <li>或使用 <strong>长按</strong>（约 0.4 秒）来插旗</li>
              <li>建议点 <strong>全屏</strong> 减少地址栏遮挡（部分浏览器不支持原生全屏时会使用“沉浸模式”替代）。</li>
            </ul>
          </div>
        </div>
      </section>

      <section>
        <h3>快速翻开周围（Chord / Quick Open）</h3>
        <p>当一个数字格周围你插的旗数量 <strong>刚好等于该数字</strong> 时，可以对它执行“快速翻开周围”。</p>
        <ol>
          <li>先插旗：把你确定是雷的格子标上 🚩</li>
          <li>当周围旗子数量 == 数字时：</li>
          <li>对该数字格执行快速翻开（电脑双击/Enter；手机切换到“快速翻开”模式点击）</li>
          <li>系统会自动翻开周围所有“未翻开且未插旗”的格子</li>
        </ol>
        <p class="warn">⚠️ 如果旗子插错，快速翻开可能直接翻到雷导致失败。</p>
      </section>

      <section>
        <h3>首次点击必不踩雷（本项目规则）</h3>
        <ul>
          <li>第一次翻开 <strong>绝不会是雷</strong>。</li>
          <li>并尽量保证第一次点击周围 <strong>3×3 区域更安全</strong>，更容易开出一片空白。</li>
        </ul>
      </section>

      <section>
        <h3>胜利与失败</h3>
        <ul>
          <li><strong>胜利</strong>：所有非雷格子都被翻开（不要求把所有雷插旗）。</li>
          <li><strong>失败</strong>：翻开到任意一个雷（💣），踩中的格子显示 💥。</li>
        </ul>
      </section>

      <section>
        <h3>新手推理技巧</h3>
        <ul>
          <li>从空白展开区域边缘开始推理，尽量减少“纯猜”。</li>
          <li>当某数字周围未翻开格子数量 == 该数字 - 已插旗数量，则这些未翻开格都应是雷。</li>
          <li>当某数字周围旗子数量 == 数字，则其余未翻开格都应安全（可快速翻开）。</li>
        </ul>
      </section>
    </div>

    <div class="dialog__actions">
      <button class="btn btn--primary" value="ok" type="submit">知道了</button>
    </div>
  </form>
</dialog>

  <!-- 帮助/关于对话框 -->
  <dialog id="helpDialog" class="dialog" aria-label="玩法帮助">
    <form method="dialog" class="dialog__content dialog__content--wide">
      <h2 class="dialog__title">玩法与操作</h2>

      <div class="help">
        <section>
          <h3>桌面端（鼠标 + 键盘）</h3>
          <ul>
            <li><strong>左键</strong>：翻开格子</li>
            <li><strong>右键</strong>：插旗 / 取消旗</li>
            <li><strong>双击数字</strong>（或 <kbd>Enter</kbd>）：当周围旗子数量等于数字时，快速翻开周围未翻开的格子</li>
            <li><strong>方向键</strong>：移动焦点；<strong>空格</strong>：翻开；<strong>F</strong>：插旗</li>
          </ul>
        </section>

        <section>
          <h3>手机端（触屏）</h3>
          <ul>
            <li>默认模式为<strong>翻开</strong>：点击格子即可翻开。</li>
            <li>点击顶部的<strong>插旗</strong>模式：点格子插旗。</li>
            <li>点击<strong>快速翻开</strong>模式：点数字格尝试快速翻开周围。</li>
            <li>也支持<strong>长按插旗</strong>（更稳妥，避免误触）。</li>
          </ul>
        </section>

        <section>
          <h3>提示</h3>
          <ul>
            <li>首次点击<strong>必不踩雷</strong>，并尽量保证首次点击周围可展开。</li>
            <li>剩余雷数 = 总雷数 - 已插旗数（不代表一定正确）。</li>
            <li>可在系统设置中启用“减少动态效果”，本游戏会自动降低动画。</li>
          </ul>
        </section>
      </div>

      <div class="dialog__actions">
        <button class="btn btn--primary" value="ok" type="submit">知道了</button>
      </div>
    </form>
  </dialog>

  <!-- 结算弹窗 -->
  <dialog id="resultDialog" class="dialog" aria-label="游戏结果">
    <form method="dialog" class="dialog__content">
      <h2 class="dialog__title" id="resultTitle">胜利！</h2>
      <p class="dialog__desc" id="resultDesc">你用时 00:00。</p>

      <div class="result-anim" aria-hidden="true">
        <div class="spark spark--1"></div>
        <div class="spark spark--2"></div>
        <div class="spark spark--3"></div>
      </div>

      <div class="dialog__actions">
        <button class="btn" value="close" type="submit">关闭</button>
        <button class="btn btn--primary" id="playAgain" value="again" type="submit">再来一局</button>
      </div>
    </form>
  </dialog>

  <!-- ⚠️ 重要：不用 ESModule（type="module"） + 用相对路径，保证 file:// 直接打开也能跑 -->
  <script src="./js/storage.js?v=1.0.12"></script>
  <script src="./js/sound.js?v=1.0.12"></script>
  <script src="./js/game.js?v=1.0.12"></script>
  <script src="./js/ui.js?v=1.0.12"></script>
  <script src="./js/app.js?v=1.0.12"></script>
</body>
</html>
